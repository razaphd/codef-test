# CodeFlowOps Documentation Drift Detection
# This workflow checks if your documentation is out of sync with your code.
# Learn more: https://codeflowops.com/docs/drift-detection

name: CodeFlowOps Documentation Drift Check

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    # Weekly check every Monday at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  drift-check:
    runs-on: ubuntu-latest
    name: Check Documentation Drift
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    # Skip if PR from fork (no secrets access)
    if: |
      github.event_name != 'pull_request' || 
      github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check for Drift
        id: drift
        run: |
          echo "üîç Checking documentation drift..."
          
          # Read manifest
          if [ ! -f "./codeflowops-manifest.json" ]; then
            echo "‚ùå Manifest not found"
            exit 1
          fi
          
          MANIFEST=$(cat ./codeflowops-manifest.json)
          
          # Get changed files (for PRs)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | jq -R -s -c 'split("\n") | map(select(length > 0))' || echo "[]")
          fi
          
          # Call CodeFlowOps API
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          
          RESPONSE=$(curl -s -X POST "https://codeflowops.com/api/drift/check" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CODEFLOWOPS_API_KEY }}" \
            -d "{
              \"manifest\": $MANIFEST,
              \"changedFiles\": $CHANGED_FILES,
              \"owner\": \"$OWNER\",
              \"repo\": \"$REPO_NAME\",
              \"sha\": \"${{ github.sha }}\",
              \"event\": \"${{ github.event_name }}\"
            }")
          
          echo "API Response: $RESPONSE"
          
          # Parse response - check if status is drift_detected
          STATUS=$(echo "$RESPONSE" | jq -r '.status // "unknown"')
          DRIFT_DETECTED="false"
          if [ "$STATUS" == "drift_detected" ]; then
            DRIFT_DETECTED="true"
          fi
          
          # Build summary from results
          HEALTH_SCORE=$(echo "$RESPONSE" | jq -r '.healthScore // 100')
          TOTAL_LINKS=$(echo "$RESPONSE" | jq -r '.summary.totalCodeLinks // 0')
          DRIFT_COUNT=$(echo "$RESPONSE" | jq -r '.summary.linksWithDrift // 0')
          
          SUMMARY="**Health Score:** $HEALTH_SCORE%\n\n**Code Blocks Checked:** $TOTAL_LINKS\n**Blocks with Drift:** $DRIFT_COUNT"
          
          # Get detailed drift info
          DRIFT_DETAILS=$(echo "$RESPONSE" | jq -r '.results[] | select(.hasDrift == true) | "- **(.codeLink.sectionTitle)** ((.codeLink.filePath):(.codeLink.startLine)-(.codeLink.endLine)): (.diffPreview // "Content changed")"' 2>/dev/null || echo "")
          if [ -n "$DRIFT_DETAILS" ]; then
            SUMMARY="$SUMMARY\n\n**Drifted Sections:**\n$DRIFT_DETAILS"
          fi
          
          echo "drift_detected=$DRIFT_DETECTED" >> $GITHUB_OUTPUT
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ "$DRIFT_DETECTED" == "true" ]; then
            echo "‚ö†Ô∏è Documentation drift detected! Health score: $HEALTH_SCORE%"
          else
            echo "‚úÖ Documentation is up to date"
          fi
        env:
          CODEFLOWOPS_API_KEY: ${{ secrets.CODEFLOWOPS_API_KEY }}

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.drift.outputs.summary }}`;
            const body = '## üìö Documentation Drift Detected\n\n' + summary + '\n\n---\n*Generated by [CodeFlowOps](https://codeflowops.com)*';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
